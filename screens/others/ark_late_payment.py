"""
ã‚¢ãƒ¼ã‚¯é…å»¶æå®³é‡‘å‡¦ç†ç”»é¢ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
Business Data Processor

ã‚¢ãƒ¼ã‚¯æ®‹å‚µã®æ›´æ–°å‡¦ç†ç”»é¢
"""

import streamlit as st
from components.result_display import display_processing_result, display_error_result
from services.debt_update import process_ark_late_payment_data


def show_ark_late_payment():
    st.header("ğŸ’° ã‚¢ãƒ¼ã‚¯æ®‹å‚µã®æ›´æ–°")
    st.markdown("**ãƒ•ã‚£ãƒ«ã‚¿æ¡ä»¶:**")
    st.markdown('<div class="filter-condition">', unsafe_allow_html=True)
    st.markdown("â€¢ ãƒ‡ãƒ¼ã‚¿çµ±åˆ â†’ ã‚¢ãƒ¼ã‚¯ãƒ‡ãƒ¼ã‚¿ + ContractList ã®çµåˆå‡¦ç†")
    st.markdown("â€¢ ãƒãƒƒãƒãƒ³ã‚° â†’ ç®¡ç†ç•ªå·ã§ã®ç…§åˆå‡¦ç†")
    st.markdown("â€¢ æ®‹å‚µæ›´æ–° â†’ ç®¡ç†å‰æ»ç´é¡ã®æ›´æ–°å‡¦ç†")
    st.markdown('</div>', unsafe_allow_html=True)
    st.info("ğŸ“‚ å¿…è¦ãƒ•ã‚¡ã‚¤ãƒ«: ã‚¢ãƒ¼ã‚¯ãƒ‡ãƒ¼ã‚¿ + ContractListï¼ˆ2ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ï¼‰")
    
    col1, col2 = st.columns(2)
    with col1:
        st.markdown("**ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«1: ã‚¢ãƒ¼ã‚¯ãƒ‡ãƒ¼ã‚¿**")
        file1 = st.file_uploader("ã‚¢ãƒ¼ã‚¯ãƒ‡ãƒ¼ã‚¿.csvã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰", type="csv", key="ark_late_file1")
    with col2:
        st.markdown("**ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«2: ContractList**")
        file2 = st.file_uploader("ContractList_*.csvã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰", type="csv", key="ark_late_file2")
    
    if file1 and file2:
        try:
            # ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã‚’èª­ã¿å–ã‚Š
            file_contents = [file1.read(), file2.read()]
            st.success(f"âœ… {file1.name}: èª­ã¿è¾¼ã¿å®Œäº†")
            st.success(f"âœ… {file2.name}: èª­ã¿è¾¼ã¿å®Œäº†")
            
            if st.button("å‡¦ç†ã‚’å®Ÿè¡Œ", type="primary"):
                with st.spinner("å‡¦ç†ä¸­..."):
                    result = process_ark_late_payment_data(file_contents[0], file_contents[1])
                    
                if result is not None:
                    result_df, output_filename = result
                    # å…±é€šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§çµæœè¡¨ç¤º
                    display_processing_result(result_df, [], output_filename)
                else:
                    st.warning("æ¡ä»¶ã«åˆè‡´ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚")
        except Exception as e:
            display_error_result(f"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
    elif file1 or file2:
        st.warning("2ã¤ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚")