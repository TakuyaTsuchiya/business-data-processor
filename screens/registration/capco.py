"""
ã‚«ãƒ—ã‚³æ–°è¦ç™»éŒ²å‡¦ç†ç”»é¢ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
Business Data Processor

ã‚«ãƒ—ã‚³ç”¨ã®æ–°è¦ç™»éŒ²å‡¦ç†ç”»é¢
"""

import streamlit as st
from datetime import datetime
from components.result_display import display_processing_result, display_error_result
from processors.capco_registration import process_capco_data


def show_capco_registration():
    st.header("ğŸ“‹ ã‚«ãƒ—ã‚³æ–°è¦ç™»éŒ²")
    st.markdown("**ãƒ•ã‚£ãƒ«ã‚¿æ¡ä»¶:**")
    st.markdown('<div class="filter-condition">', unsafe_allow_html=True)
    st.markdown("â€¢ ãƒ‡ãƒ¼ã‚¿çµ±åˆ â†’ ã‚«ãƒ—ã‚³ãƒ‡ãƒ¼ã‚¿ + ContractList ã®çµåˆå‡¦ç†")
    st.markdown('</div>', unsafe_allow_html=True)
    st.info("ğŸ“‚ å¿…è¦ãƒ•ã‚¡ã‚¤ãƒ«: ã‚«ãƒ—ã‚³ãƒ‡ãƒ¼ã‚¿ + ContractListï¼ˆ2ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ï¼‰")
    
    col1, col2 = st.columns(2)
    with col1:
        st.markdown("**ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«1: ã‚«ãƒ—ã‚³ãƒ‡ãƒ¼ã‚¿**")
        file1 = st.file_uploader("ã‚«ãƒ—ã‚³ãƒ‡ãƒ¼ã‚¿.csvã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰", type="csv", key="capco_file1")
    with col2:
        st.markdown("**ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«2: ContractList**")
        file2 = st.file_uploader("ContractList_*.csvã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰", type="csv", key="capco_file2")
    
    if file1 and file2:
        try:
            # ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã‚’èª­ã¿å–ã‚Š
            file_contents = [file1.read(), file2.read()]
            st.success(f"âœ… {file1.name}: èª­ã¿è¾¼ã¿å®Œäº†")
            st.success(f"âœ… {file2.name}: èª­ã¿è¾¼ã¿å®Œäº†")
            
            if st.button("å‡¦ç†ã‚’å®Ÿè¡Œ", type="primary"):
                with st.spinner("å‡¦ç†ä¸­..."):
                    result_df, logs, filename = process_capco_data(file_contents[0], file_contents[1])
                    
                # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å†è¨­å®šï¼ˆé–¢æ•°ã‹ã‚‰ã®ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ä½¿ç”¨ï¼‰
                if filename:
                    # å…±é€šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§çµæœè¡¨ç¤º
                    display_processing_result(result_df, logs, filename)
                else:
                    # ãƒ•ã‚¡ã‚¤ãƒ«åãŒãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’è¨­å®š
                    timestamp = datetime.now().strftime("%m%d")
                    filename = f"{timestamp}ã‚«ãƒ—ã‚³_æ–°è¦ç™»éŒ².csv"
                    display_processing_result(result_df, logs, filename)
        except Exception as e:
            display_error_result(f"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
    elif file1 or file2:
        st.warning("2ã¤ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚")