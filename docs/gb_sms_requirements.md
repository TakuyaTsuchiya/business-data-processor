# ガレージバンク契約者SMS機能 要件定義書

## 1. 概要

ガレージバンク向けのSMS送信用CSV加工機能を実装する。
フェイスSMS契約者と同様のロジックで、委託先法人IDを7に変更したもの。

## 2. 画面仕様

### 2.1 ボタン配置
- 位置: サイドバーの「ガレージバンク残債の取り込み」ボタンの下
- ボタン名: 「ガレージバンク契約者SMS」

### 2.2 画面タイトル
- タイトル: SMS送信用CSV加工
- サブタイトル: ガレージバンク　契約者

## 3. フィルタ条件

| No | 列名 | 条件 | 備考 |
|----|------|------|------|
| 1 | 委託先法人ID (列118) | = 7 のみ | ガレージバンク固有 |
| 2 | 入金予定日 (列72) | 前日以前 または NaN | 当日・未来日を除外 |
| 3 | 回収ランク (列86) | 「弁護士介入」「破産決定」「死亡決定」を除外 | フェイスと同じ |
| 4 | 滞納残債 (列71) | 1円以上 | 0円以下を除外 |
| 5 | 入金予定金額 (列73) | 2, 3, 5 を除外 | フェイスと同じ |
| 6 | TEL携帯 (列27) | 090/080/070形式のみ | 正規表現: `^(090\|080\|070)-\d{4}-\d{4}$` |

## 4. 出力フォーマット

SMS共通テンプレート（59列）を使用。

| 列 | 項目名 | マッピング元 |
|----|--------|-------------|
| A | 電話番号 | TEL携帯 |
| B | (info1)契約者名 | 契約者氏名 |
| C | (info2)物件名 | 物件名 + 物件番号（全角スペース結合） |
| D | (info3)金額 | 滞納残債（カンマ区切り） |
| E | (info4)銀行口座 | 回収口座5項目（全角スペース結合） |
| F | (info5)メモ | 管理番号 |
| G-AY | 空列 | 空文字 |
| AZ | 保証人 | 空文字 |
| BA | 連絡人 | 空文字 |
| BB | 支払期限 | ユーザー指定日付（YYYY年MM月DD日形式） |

## 5. 出力ファイル名

`{MMDD}ガレージバンクSMS契約者.csv`

例: 0121ガレージバンクSMS契約者.csv

## 6. 実装タスクリスト

### 6.1 ドメイン層
- [ ] `domain/rules/business_rules.py` に GB用定数を追加
  - CLIENT_IDS['gb'] = [7]
  - EXCLUDE_AMOUNTS['gb'] = [2, 3, 5]

### 6.2 プロセッサ層
- [ ] `processors/gb_sms/__init__.py` を作成
- [ ] `processors/gb_sms/contract.py` を作成
  - process_gb_sms_contract_data() 関数を実装

### 6.3 サービス層
- [ ] `services/sms.py` に GB SMS のインポートを追加

### 6.4 画面層
- [ ] `screens/sms/gb.py` を作成
  - show_gb_sms_contract() 関数を実装

### 6.5 アプリケーション層
- [ ] `components/sidebar.py` にボタンを追加
- [ ] `app.py` の PROCESSOR_MAPPING に追加

### 6.6 テスト
- [ ] `tests/test_gb_sms_contract.py` を作成
  - フィルタ条件のテスト
  - 出力フォーマットのテスト
  - エッジケースのテスト

## 7. テストケース

### 7.1 フィルタテスト
1. 委託先法人ID=7のみ残る
2. 委託先法人ID!=7は除外される
3. 入金予定日が前日以前 → 残る
4. 入金予定日が当日 → 除外
5. 入金予定日がNaN → 残る
6. 回収ランク=弁護士介入 → 除外
7. 回収ランク=破産決定 → 除外
8. 回収ランク=死亡決定 → 除外
9. 滞納残債=0 → 除外
10. 滞納残債>=1 → 残る
11. 入金予定金額=2,3,5 → 除外
12. TEL携帯が090/080/070形式 → 残る
13. TEL携帯が形式不正 → 除外

### 7.2 出力フォーマットテスト
1. 電話番号が正しくマッピングされる
2. 物件名と物件番号が全角スペースで結合される
3. 金額がカンマ区切りでフォーマットされる
4. 銀行口座情報が全角スペースで結合される
5. 支払期限が「YYYY年MM月DD日」形式になる

---

作成日: 2026-01-21
作成者: Claude Code
