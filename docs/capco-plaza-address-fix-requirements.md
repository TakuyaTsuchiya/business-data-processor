# カプコ・プラザ新規登録 住所分割バグ修正 - 要件定義書

## 概要

カプコ新規登録およびプラザ新規登録において、市名に「村」を含む住所が正しくパースされない問題を修正する。

## 背景・経緯

- 2026-02-16 カプコ新規登録の本番運用にて発覚
- 東村山市、武蔵村山市、羽村市の住所が誤分割されていた
- 同様の問題はGB新規登録で2026-01-23に修正済み（`docs/gb_registration_address_fix.md`参照）
- アーク・IOG新規登録は当初から`AddressSplitter`を使用しており問題なし

## 問題の詳細

### 発生事象

| 入力住所 | 現住所2（期待） | 現住所2（実際） | 現住所3（実際） |
|---|---|---|---|
| 東京都東村山市恩多町5-25-2 | 東村山市 | 山市 | 山市恩多町5-25-2 |
| 東京都東村山市久米川町1-22-25 | 東村山市 | 山市 | 山市久米川町1-22-25 |
| 東京都武蔵村山市学園3-38-1 | 武蔵村山市 | 山市 | 村山市学園3-38-1 |
| 東京都羽村市羽西1-10-10 | 羽村市 | 市 | 村市羽西1-10-10 |

### 原因

正規表現 `r'([^市区町村]*[町村])'` が「村」を町村の区切り文字として誤認識。
`[^市区町村]` により「市区町村」の文字を含まない部分のみマッチするため、
「東村山市」の「村」で区切られ、市区町村が壊れる。

### 影響範囲

- **カプコ新規登録** (`processors/capco_registration.py`) - 正規表現ベース
- **プラザ新規登録** (`processors/plaza_registration.py`) - 正規表現ベース（同一ロジック）

### 影響を受ける市名（代表例）

- 「村」を含む市: 東村山市、武蔵村山市、羽村市、村上市、村山市、大村市、田村市
- 「町」を含む市: 町田市（ハードコードで個別対応済みだが不完全）
- 「市」を含む市: 市原市、市川市（ハードコードで個別対応済みだが不完全）

## 要件

### 機能要件

1. 市名に「村」「町」「市」を含む住所を正しく分割できること
2. 政令指定都市（横浜市港北区等）を正しく分割できること
3. 東京23区を正しく分割できること
4. 郡（○○郡○○町）を正しく分割できること
5. 通常の住所（川崎市等）の分割に影響がないこと

### 非機能要件

1. 既存の `AddressSplitter` クラスを再利用すること（新規ロジック不要）
2. メソッドのシグネチャ・戻り値の形式を変更しないこと（呼び出し元への影響なし）
3. テストを追加し、回帰を防止すること

## 修正方針

既にGB・アーク・IOGで実績のある辞書ベース `AddressSplitter`（`processors/common/address_splitter.py`）に切り替える。

---
作成日: 2026-02-16
