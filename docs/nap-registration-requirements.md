# ナップ新規登録機能 要件定義書

## 1. 概要

ナップ賃貸保証株式会社からミライル様経由で提供されるExcelデータを、新規登録用の標準111列CSVフォーマットに変換する機能。

## 2. 背景

- ナップ社はミライル社に業務委託している
- ミライル様から「ミライル様　XX月分依頼データ.xlsx」形式でデータ提供
- 既存のContractListと重複チェックを行い、新規データのみ登録対象とする

## 3. 機能要件

### 3.1 入力

#### 3.1.1 ミライル様Excelファイル
- **ファイル形式**: Excel (.xlsx)
- **ヘッダー行**: 14行目（skiprows=13で読み込み）
- **データ列数**: 51列
- **主要列**:
  - 承認番号（引継番号として使用）
  - 契約者氏名 / 契約者氏名かな
  - 契約者電話 / 契約者携帯1
  - 物件名 / 部屋番号
  - 物件住所１〜３
  - 契約者１住所１〜３
  - 賃料関連（賃料合計額、賃料、管理費公益費、水道代、駐車場、その他費用）
  - 連帯保証人情報（連保人1氏名〜連保人1携帯番号）
  - 緊急連絡人情報（緊急連絡人氏名〜緊急連絡人携帯１）
  - 勤務先情報（契約者勤務先名、契約者勤務先電話）
  - 加盟店: 加盟店名（管理会社として使用）

#### 3.1.2 ContractListファイル
- **ファイル形式**: CSV
- **文字コード**: CP932/Shift_JIS/UTF-8（自動判定）
- **使用目的**: 重複チェック、既存データとのマージ
- **重要列**:
  - 引継番号（Excelの承認番号と照合）
  - 委託先法人ID（値が5のデータのみ対象）

### 3.2 処理

#### 3.2.1 重複チェック
- **チェックキー**: ミライル様Excel「承認番号」↔ ContractList「引継番号」
- **フィルタ条件**: ContractListの「委託先法人ID」が5のデータのみ対象
- **処理内容**:
  - 重複データ（既存契約）は除外
  - 新規データのみを処理対象とする

#### 3.2.2 データ変換
- 51列 → 111列の標準フォーマットに変換
- 固定値の設定
- データマッピング（後述）

### 3.3 出力

#### 3.3.1 出力ファイル
- **ファイル名**: `MMDDナップ新規登録.csv`（MMDDは処理日の月日）
- **ファイル形式**: CSV
- **文字コード**: CP932
- **列数**: 111列（標準新規登録フォーマット）

#### 3.3.2 固定値

| 列名 | 固定値 | 備考 |
|------|--------|------|
| クライアントCD | 9268 | ナップ社識別コード |
| 委託先法人ID | 5 | ミライル社法人ID |
| 入居ステータス | 入居中 | - |
| 滞納ステータス | 未精算 | - |
| 受託状況 | 契約中 | - |
| 契約種類 | レントワン | - |
| 管理受託日 | YYYY/MM/DD | 処理実行日 |
| 回収口座金融機関CD | 1 | みずほ銀行 |
| 回収口座金融機関名 | みずほ銀行 | - |
| 回収口座種類 | 普通 | - |
| 回収口座番号 | 4389306 | - |
| 回収口座名義 | ナップ賃貸保証株式会社 | - |

#### 3.3.3 データマッピング

| 出力列名 | 入力列名（Excel） | 変換ルール |
|----------|-------------------|------------|
| 引継番号 | 承認番号 | そのまま |
| 契約者氏名 | 契約者氏名 | そのまま |
| 契約者カナ | 契約者氏名かな | そのまま |
| 契約者TEL自宅 | 契約者電話 | そのまま |
| 契約者TEL携帯 | 契約者携帯1 | そのまま |
| 契約者現住所1 | 契約者１住所１ | そのまま |
| 契約者現住所2 | 契約者１住所２ | そのまま |
| 契約者現住所3 | 契約者１住所３ | そのまま |
| 物件名 | 物件名 | そのまま |
| 部屋番号 | 部屋番号 | そのまま |
| 物件住所1 | 物件住所１ | そのまま |
| 物件住所2 | 物件住所２ | そのまま |
| 物件住所3 | 物件住所３ | そのまま |
| 月額賃料 | 賃料合計額 | そのまま |
| 管理費 | 管理費公益費 | そのまま |
| 水道代 | 水道代 | そのまま |
| 駐車場代 | 駐車場 | そのまま |
| その他費用1 | その他費用 | そのまま |
| 契約者勤務先名 | 契約者勤務先名 | そのまま |
| 契約者勤務先TEL | 契約者勤務先電話 | そのまま |
| 保証人１氏名 | 連保人1氏名 | そのまま |
| 保証人１カナ | 連保人1氏名かな | そのまま |
| 保証人１契約者との関係 | 連帯保証人関係 | そのまま |
| 保証人１生年月日 | 連保人1生年月日 | そのまま |
| 保証人１郵便番号 | 連保人1郵便番号 | そのまま |
| 保証人１住所1 | 連保人1住所１ | そのまま |
| 保証人１住所2 | 連保人1住所２ | そのまま |
| 保証人１住所3 | 連保人1住所３ | そのまま |
| 保証人１TEL自宅 | 連保人1電話 | そのまま |
| 保証人１TEL携帯 | 連保人1携帯番号 | そのまま |
| 緊急連絡人１氏名 | 緊急連絡人氏名 | そのまま |
| 緊急連絡人１カナ | 緊急連絡人氏名かな | そのまま |
| 緊急連絡人１契約者との関係 | 緊急連絡人関係 | そのまま |
| 緊急連絡人１郵便番号 | 緊急連絡人郵便番号 | そのまま |
| 緊急連絡人１現住所1 | 緊急連絡人住所１ | そのまま |
| 緊急連絡人１現住所2 | 緊急連絡人住所２ | そのまま |
| 緊急連絡人１現住所3 | 緊急連絡人住所３ | そのまま |
| 緊急連絡人１TEL自宅 | 緊急連絡人電話 | そのまま |
| 緊急連絡人１TEL携帯 | 緊急連絡人携帯１ | そのまま |
| 管理会社 | 加盟店: 加盟店名 | そのまま |

※上記以外の列は空白または固定値

### 3.4 画面表示

#### 3.4.1 画面配置
- **カテゴリ**: その他
- **サブカテゴリ**: 新規登録
- **メニュー名**: ナップ新規登録

#### 3.4.2 UI要素
- タイトル: 📋 ナップ新規登録
- フィルタ条件表示
- ファイルアップローダー（2つ）
  1. ミライル様Excelファイル
  2. ContractList CSVファイル
- 処理実行ボタン
- 結果表示（件数統計、ログ、ダウンロードボタン）

## 4. 非機能要件

### 4.1 性能
- 処理時間: 1000件のデータで1分以内

### 4.2 信頼性
- エンコーディングエラーの自動リカバリー（CP932/Shift_JIS/UTF-8を試行）
- データ検証（必須項目チェック）

### 4.3 保守性
- 既存のプラザ新規登録コードを最大限再利用
- 設定値はConfigクラスで集中管理

## 5. 制約事項

- 111列フォーマットは絶対変更禁止（アークシステム仕様）
- 空列（108-110列目）も含めて厳密に111列
- 絵文字使用禁止（CP932エンコーディングエラー防止）

## 6. テストケース

### 6.1 正常系
1. 新規データのみ（重複なし）
2. 全データ重複（新規0件）
3. 一部重複

### 6.2 異常系
1. Excelファイルのヘッダー行が不正
2. 必須列が存在しない
3. ContractListが空
4. 委託先法人ID=5のデータが存在しない

## 7. リリース計画

1. feature/nap-registrationブランチで開発
2. TDDでテストを先に作成
3. 実装完了後、PR作成
4. サブエージェントレビュー（/reviewコマンド）
5. レビュー対応後、mainブランチへマージ
