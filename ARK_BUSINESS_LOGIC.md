# アーク新規登録 ビジネスロジック仕様書

## 📋 概要
- **目的**: 案件取込用レポートCSVとContractListCSVを統合し、111列テンプレート準拠のアーク新規登録CSVを生成
- **入力**: 案件取込用レポート.csv + ContractList.csv  
- **出力**: MMDDアーク新規登録.csv（111列完全準拠）

## 🔄 処理フロー
1. **ファイル読み込み**: 自動エンコーディング判定（utf-8/shift_jis/cp932対応）
2. **重複チェック**: ContractListの引継番号と照合して重複を除外
3. **データ変換**: 案件取込用レポートを111列テンプレートに変換
4. **CSV出力**: CP932エンコーディングで出力

## 📊 データマッピング

### 基本情報
| 出力列名 | 入力データソース | 変換処理 |
|---------|-----------------|---------|
| 引継番号 | 契約番号 | 先頭に"0"を付与 |
| 契約者氏名 | 契約元帳: 主契約者 | 全スペース除去 |
| 契約者カナ | 主契約者（カナ） | 半角→全角変換、スペース除去 |
| 契約者生年月日 | 生年月日 | そのまま |

### 電話番号処理
| 出力列名 | 入力データソース | 特殊処理 |
|---------|-----------------|---------|
| 契約者TEL自宅 | 自宅TEL1 | 携帯TELが空の場合、自宅→携帯に移動 |
| 契約者TEL携帯 | 携帯TEL1 | 電話番号正規化（記号統一、不要文字除去） |

### 住所分割処理
**契約者現住所**: 物件住所から分割
- **郵便番号**: 〒123-4567形式で抽出
- **現住所1**: 都道府県（47都道府県リストで照合）
- **現住所2**: 市区町村（政令指定都市対応：「○○市○○区」全体を取得）
- **現住所3**: 町村以下　全角スペース　物件名　全角スペース　部屋番号

### 物件情報
| 出力列名 | 入力データソース | 変換処理 |
|---------|-----------------|---------|
| 物件名 | 物件名 | 部屋番号部分を除去 |
| 部屋番号 | 物件名から抽出or部屋番号列 | 正規表現で「101号室」→「101」 |
| 物件住所郵便番号 | 物件郵便番号 | そのまま |
| 物件住所1-3 | 物件住所1 | 住所分割処理適用 |

### 金額情報
| 出力列名 | 入力データソース | 変換処理 |
|---------|-----------------|---------|
| 月額賃料 | 賃料 | カンマ除去 |
| 管理費 | - | 空白（仕様書通り） |
| 共益費 | 管理共益費 | カンマ除去 |
| 駐車場代 | 駐車場料金 | カンマ除去 |
| その他費用1 | その他料金 | カンマ除去 |
| その他費用2 | 決済サービス料 | カンマ除去 |
| 敷金 | 敷金 | カンマ除去 |
| 礼金 | 礼金 | カンマ除去 |

### 勤務先情報
| 出力列名 | 入力データソース | 変換処理 |
|---------|-----------------|---------|
| 契約者勤務先名 | 勤務先1 | そのまま |
| 契約者勤務先カナ | - | 空白 |
| 契約者勤務先TEL | 勤務先TEL1 | そのまま |
| 勤務先業種 | - | 空白 |
| 契約者勤務先郵便番号 | - | 空白 |
| 契約者勤務先住所1 | - | 空白 |
| 契約者勤務先住所2 | - | 空白 |
| 契約者勤務先住所3 | - | 空白 |

### 退去手続き費用計算
**算出ロジック**: max(賃料+管理共益費+駐車場料金, 70000)
- 最低金額: 70,000円保証

### 回収口座情報
| 出力列名 | 設定値 | 備考 |
|---------|--------|------|
| 回収口座金融機関CD | 310 | 固定値 |
| 回収口座金融機関名 | GMOあおぞらネット銀行 | 固定値 |
| 回収口座種類 | 普通 | 固定値 |
| 回収口座名義 | アーク株式会社 | 固定値 |
| 回収口座支店名 | バーチャル口座(支店) | 入力データから |
| 回収口座番号 | バーチャル口座(口座番号) | 入力データから |

### 固定値設定
| 出力列名 | 固定値 | 
|---------|--------|
| 入居ステータス | 入居中 |
| 滞納ステータス | 未精算 |
| 受託状況 | 契約中 |
| 契約種類 | バックレント |
| クライアントCD | 10 |
| 水道代 | 0 |
| 共益費 | 0 |
| 更新契約手数料 | 1 |
| 退去済手数料 | 0 |
| 入居中滞納手数料 | 0 |
| 入居中正常手数料 | 0 |
| 登録フラグ | （空白） |

### 引継情報生成
**フォーマット**: `●20日～25日頃に督促手数料2,750円or2,970円が加算されることあり。案内注意！！　●入居日：{入居日}`

### 保証人・緊急連絡人判定
**判定基準**: 種別／続柄２の値で分類
- **保証人**: "保証人"文字列を含む → 保証人１に設定
- **緊急連絡人**: "緊急連絡"または"(法)代表者１/"を含む → 緊急連絡人１に設定

**マッピング対象列**:
- 氏名: 名前2（全スペース除去）
- カナ: 名前2（カナ）（半角→全角、スペース除去）
- 生年月日: 生年月日2
- 電話番号: 自宅TEL2、携帯TEL2（正規化処理）
- 住所: 住所2（分割処理適用）

## 🔍 重複チェックロジック
1. 案件取込用レポートの契約番号に"0"を付与して引継番号を生成
2. ContractListの引継番号と照合
3. 重複する引継番号のレコードを除外
4. 除外件数をログに記録

## 📝 ログ出力項目
- ファイル読み込み件数
- 重複チェック結果（除外件数）
- 保証人・緊急連絡人の件数統計
- 最終出力件数

## ⚠️ 重要な注意事項
1. **111列テンプレート完全準拠**: 列数・列名・列順序を絶対に変更しない
2. **空列処理**: 108-110番目は空列、pandas空列処理問題に対応必要
3. **登録フラグ位置**: 111番目（DG列）に正確に配置
4. **電話番号正規化**: 全角→半角、記号統一、不要文字除去
5. **住所分割**: 政令指定都市対応（千葉市美浜区など）
6. **エンコーディング**: 出力はCP932固定

## 🔧 技術実装ポイント
- **pandas空列問題**: 仮名前方式で解決
- **エンコーディング自動判定**: utf-8/shift_jis/cp932の順で試行
- **正規表現**: 郵便番号抽出、部屋番号抽出、市区町村抽出
- **データ型安全性**: pd.isna()チェック、str()変換の安全処理

---
**作成日**: 2024年8月5日  
**目的**: アーク新規登録プロセッサ再構築のためのビジネスロジック保全