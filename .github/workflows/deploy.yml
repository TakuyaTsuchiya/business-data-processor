name: Deploy to Production
on:
  push:
    branches: [main]
    paths:
      - '**.py'
      - 'requirements.txt'
      - 'Dockerfile'
      - 'docker-compose.yml'
      - '.github/workflows/**'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deploy even without changes'
        required: false
        type: boolean

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "=== Starting deployment at $(date) ==="
            
            # Navigate to application directory
            cd /home/ubuntu/apps/business-data-processor
            
            # Pull latest code
            echo "Pulling latest code..."
            git pull origin main
            
            # Stop current containers
            echo "Stopping current containers..."
            docker-compose down
            
            # Build and start new containers
            echo "Building and starting new containers..."
            docker-compose up -d --build
            
            # Wait for application to start
            echo "Waiting for application to start..."
            sleep 15
            
            # Health check
            echo "Performing health check..."
            if curl -f http://localhost:8501/_stcore/health > /dev/null 2>&1; then
                echo "âœ… Health check passed - Application is running"
                echo "ğŸŒ Application available at: https://mirail.net"
            else
                echo "âŒ Health check failed - Check application logs"
                docker-compose logs --tail=50
                exit 1
            fi
            
            echo "=== Deployment completed successfully at $(date) ==="

      - name: Notify deployment result
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment completed successfully!"
            echo "ğŸŒ Application: https://mirail.net"
            echo "ğŸ“… Deployed at: $(date)"
          else
            echo "âŒ Deployment failed!"
            echo "ğŸ” Check the logs above for details"
          fi