# Business Data Processor v2.3.0

[![CI/CD Status](https://github.com/TakuyaTsuchiya/business-data-processor/workflows/Deploy%20to%20Production/badge.svg)](https://github.com/TakuyaTsuchiya/business-data-processor/actions)

**統合データ処理システム** - 革新的UIシステム搭載版

## 🌟 概要

複数の業務用データ処理アプリケーションを統合した、**革新的なプルダウンレスUI**を搭載したStreamlit製のWebアプリケーションです。不動産管理業務における契約データの変換・統合処理を自動化し、**常時表示階層メニュー**による直感的で効率的な操作を実現した業務効率化ツールです。

## 🚀 v2.3.0 新機能ハイライト

### 🎯 革新的UIシステム
- **プルダウンレス設計**: 全選択肢が常時表示で一目で確認可能
- **固定ヘッダー**: スクロール時もタイトルが常に表示
- **コンパクト配置**: ボタン間余白を極小化し、効率的な空間利用
- **統一命名**: 「～用CSV加工」で目的が明確

### 🎨 ユーザビリティ向上
- **直感的操作**: クリック一回で機能選択
- **視認性向上**: 400px幅サイドバーで情報がクリア
- **迷いゼロ**: サイドバー固定で誤操作防止

## 🐳 Docker版の特徴

### ✅ 従来版の課題を完全解決
- **文字化け問題**: 日本語環境統一で完全解決
- **Python環境依存**: インストール不要で即実行可能  
- **依存関係エラー**: すべてパッケージ化で解決
- **OS差異問題**: Windows 10/11 で同一動作保証
- **複雑な環境構築**: Docker Desktop のみで準備完了

### 🚀 簡単導入・運用
- **必要な前提**: Docker Desktop のみ（無料）
- **起動方法**: 🚀起動.bat をダブルクリック
- **環境構築**: 一切不要（全自動セットアップ）
- **所要時間**: 初回10分、2回目以降30秒
- **配布方法**: ZIP一つで他PCに完全移植

## 📊 対応プロセッサー（17種類完全統合）

### 📞 オートコール用CSV加工（12種類）

#### ミライル用オートコール（6種類）
- **契約者（10,000円を除外するパターン）**: 1万円・1万1千円を自動除外
- **契約者（10,000円を除外しないパターン）**: 残債除外なしで全件処理
- **保証人（残債除外）**: 保証人電話番号での処理（残債除外）
- **保証人（残債含む）**: 保証人電話番号での処理（残債含む）
- **緊急連絡人（残債除外）**: 緊急連絡人電話番号での処理（残債除外） 
- **緊急連絡人（残債含む）**: 緊急連絡人電話番号での処理（残債含む）

#### 📱 フェイスオートコール（3種類）
- **契約者**: 委託先法人ID（1-4）でフィルタリング
- **保証人**: フェイス委託先の保証人データ処理
- **緊急連絡人**: フェイス委託先の緊急連絡人データ処理

#### 🏪 プラザオートコール（3種類）
- **契約者**: 2ファイル処理（ContractList + Excel報告書）
- **保証人**: 基本構造実装済み（要完成化）
- **緊急連絡人**: 2ファイル処理対応

### 📋 データ変換（2種類）
#### 🏗️ アーク新規登録
- **機能**: 案件取込用レポート + ContractList の統合処理
- **特徴**: 111列統合CSV生成、住所分割、保証人判定自動化
- **用途**: アーク新規登録用データ完全変換

#### 🏢 カプコ新規登録
- **機能**: カプコレポート + ContractList の統合処理
- **特徴**: CAP-プレフィックス管理番号、住所分割、処理費用計算自動化
- **用途**: カプコ新規登録用データ完全変換

### 📱 SMS処理（2種類）
#### 📱 フェイスSMS退去済み契約者
- **機能**: ContractList*.csvから退去済み契約者SMS送信用データ生成
- **フィルタリング**: 委託先法人ID（1-4）、入金予定日、金額（2,3,5除外）、回収ランク、携帯番号
- **出力形式**: 59列構造（電話番号、契約者名、物件名、金額、銀行口座、メモ + 50空白列 + 保証人/連絡人/支払期限）
- **文字化け対策**: chardet自動検出 + CP932出力統一

#### 🔔 フェイスSMS（準備中）
- **実装枠**: 将来拡張用として準備済み

## 🚀 主な機能

### 共通機能
- ✅ **ファイルアップロード**: ドラッグ&ドロップ対応
- ✅ **自動エンコーディング判定**: UTF-8, Shift_JIS, CP932に対応
- ✅ **リアルタイム処理ログ**: 詳細な処理状況表示
- ✅ **データプレビュー**: 処理結果の即座確認
- ✅ **CSVダウンロード**: CP932エンコーディングで出力
- ✅ **統計情報表示**: データ品質・件数・内訳の表示

### ミライル契約者処理
- 委託先法人ID（空白と5）フィルタリング
- 残債10,000円・11,000円の自動除外
- 電話番号の最適化処理

### フェイス契約者処理  
- 委託先法人ID（1,2,3,4）でフィルタリング
- 回収ランク除外（死亡決定、破産決定、弁護士介入）
- 委託先別内訳の可視化

### アーク新規登録処理
- 重複データの自動除外（ContractListとの照合）
- 住所の自動分割（都道府県・市区町村・残り住所）
- 物件名から部屋番号の自動抽出
- 電話番号処理（自宅TEL→携帯TEL移動）
- 保証人・緊急連絡人の自動判定
- 退去手続き費用の自動計算（最低70,000円保証）
- 引継情報の自動生成

## 💻 技術仕様

### 開発環境
- **言語**: Python 3.8+
- **フレームワーク**: Streamlit 1.28+
- **データ処理**: pandas 2.0+, chardet 5.2+
- **UI自動化**: Playwright 1.40+（テスト用）
- **対応OS**: Windows, macOS, Linux

### アーキテクチャ
```
business-data-processor/
├── app.py                    # メインStreamlitアプリ
├── start.bat                 # ワンクリック起動バッチ
├── requirements.txt          # 依存パッケージ
├── processors/               # 業務別処理モジュール
│   ├── mirail_autocall/      # ミライルオートコール
│   │   ├── standard.py       # 残債除外版
│   │   └── with_debt.py      # 残債含む版
│   ├── faith_autocall/       # フェイスオートコール
│   │   └── standard.py       # 標準版
│   ├── plaza_autocall/       # プラザオートコール（準備中）
│   │   └── standard.py       # 標準版
│   ├── faith_sms/            # フェイスSMS（準備中）
│   │   └── standard.py       # 標準版
│   └── ark_registration.py   # アーク新規登録
├── shared/                   # 共通ユーティリティ
├── templates/                # テンプレートファイル
├── screenshots/              # UIテスト用スクリーンショット
└── README.md                 # このファイル
```

## 🐳 Docker版 セットアップ

### 📌 前提条件
- Windows 10/11 (64bit)
- メモリ: 4GB以上（推奨8GB）
- ディスク: 10GB以上の空き容量

### 📥 Step 1: Docker Desktop インストール（初回のみ）
1. [Docker Desktop for Windows](https://www.docker.com/products/docker-desktop) をダウンロード
2. インストーラーを実行（デフォルト設定でOK）
3. インストール完了後、**PCを再起動**
4. タスクトレイにクジラアイコンが表示されれば準備完了

> 詳細手順: `docs/Docker_Desktop_インストールガイド.md` 参照

### 🚀 Step 2: アプリケーション起動
1. **配布パッケージを解凍**
2. **起動.bat をダブルクリック**
3. **自動的にブラウザが開く**（http://localhost:8501）

#### ⏱️ 初回起動時間について
- **初回起動**: 2-5分（Dockerイメージのダウンロード・ビルドのため）
- **2回目以降**: 30-60秒（大幅に高速化）
- **PC性能・ネット速度により変動**

### 🛑 Step 3: 終了方法
**停止.bat をダブルクリック**

---

## 🔧 従来版セットアップ（上級者向け）

<details>
<summary>クリックして展開</summary>

### 1. リポジトリのクローン
```bash
git clone https://github.com/TakuyaTsuchiya/business-data-processor.git
cd business-data-processor
```

### 2. 依存パッケージのインストール
```bash
pip install -r requirements.txt
```

### 3. アプリケーションの起動
```bash
streamlit run app.py
```

ブラウザで http://localhost:8501 にアクセス

</details>

## 📖 使用方法

### 基本的な使い方

1. **ブラウザでアプリにアクセス**
2. **左サイドバーから業務カテゴリ選択**
   - 📞 オートコール処理 → 🏢 ミライル / 📱 フェイス / 🏪 プラザ
   - 📱 SMS処理 → 📱 フェイスSMS退去済み契約者 / 🔔 フェイスSMS（準備中）
   - 📋 新規登録処理 → 📋 アーク新規登録 / 🏢 カプコ新規登録
3. **必要なCSVファイルをアップロード**
4. **🚀 処理開始ボタンをクリック**
5. **結果確認後、CSVファイルをダウンロード**

### 各プロセッサーの詳細使用方法

#### 📞 オートコール処理

##### ミライル契約者
```
📂 残債除外バージョン（without10k）:
必要ファイル: ContractList_*.csv
出力ファイル: MMDDミライル_without10k_契約者.csv
フィルタ条件: 
- 委託先法人ID: 空白と5
- 入金予定日: 前日以前またはNaN（当日は除外）
- 回収ランク: 弁護士介入を除外
- 残債除外: クライアントCD=1かつ10,000円・11,000円のレコードのみ除外
- TEL携帯: 空でない値のみ

📂 残債含む全件バージョン（with10k）:
必要ファイル: ContractList_*.csv
出力ファイル: MMDDミライル_with10k_契約者.csv
フィルタ条件: 
- 委託先法人ID: 空白と5
- 入金予定日: 前日以前またはNaN（当日は除外）
- 回収ランク: 弁護士介入を除外
- 残債含む: 全件処理（10,000円・11,000円も含む）
- TEL携帯: 空でない値のみ
```

##### ミライル保証人・緊急連絡人
```
📂 残債除外バージョン（without10k）:
必要ファイル: ContractList_*.csv
出力ファイル: MMDDミライル_without10k_保証人/緊急連絡人.csv
フィルタ条件: 契約者版と同様、TEL携帯.1/.2を使用

📂 残債含む全件バージョン（with10k）:
必要ファイル: ContractList_*.csv  
出力ファイル: MMDDミライル_with10k_保証人/緊急連絡人.csv
フィルタ条件: 残債フィルタなしの全件処理版
```

##### フェイス契約者・保証人・緊急連絡人
```
必要ファイル: ContractList_*.csv
出力ファイル: MMDDフェイス_[契約者/保証人/緊急連絡人].csv
フィルタ条件:
- 委託先法人ID: 1-4（フェイス専用範囲）
- 入金予定日: 前日以前またはNaN（当日は除外）
- 回収ランク: 弁護士介入を除外
- 残債: フィルタなし（全件処理）
```

##### プラザ契約者・保証人・緊急連絡人
```
必要ファイル: 
- ContractList_*.csv
- Excel報告書_*.xlsx
出力ファイル: MMDDプラザ_[契約者/保証人/連絡人].csv
フィルタ条件:
- 延滞額合計: 0,2,3,5円を除外
- TEL無効: 除外
- 回収ランク: 督促停止・弁護士介入を除外
```

#### 📱 SMS処理

##### フェイス退去済み契約者SMS
```
必要ファイル: ContractList_*.csv
出力ファイル: MMDDフェイス_退去済み契約者SMS.csv
フィルタ条件:
- 入居ステータス: 退去済み
- 委託先法人ID: 1-4（フェイス専用範囲）
- TEL携帯: 空でない値のみ
```

#### 📋 新規登録処理

#### アーク新規登録
```
必要ファイル: 
- 【東京支店】①案件取込用レポート*.csv
- ContractList_*.csv
出力ファイル: MMDDアーク新規登録.csv
```

#### カプコ新規登録
```
必要ファイル: 
- カプコレポート*.csv
- ContractList_*.csv
出力ファイル: MMDDカプコ新規登録.csv
```

## 🧪 テスト・品質保証

### UIテスト環境
- **Playwright**: ブラウザ自動化テスト
- **スクリーンショット取得**: 各画面の動作確認
- **自動化テスト**: UI操作の検証

### データ品質保証
- **エンコーディング自動検出**: 文字化け防止
- **データ検証**: 必須項目・形式チェック
- **エラーハンドリング**: 詳細なエラーメッセージ表示
- **処理ログ**: 全処理過程の可視化

## 🔒 セキュリティ

- **ローカル実行**: データが外部に送信されない
- **一時的処理**: アップロードファイルは処理後に破棄
- **エンコーディング対応**: 日本語データの正確な処理

## 📈 パフォーマンス

- **処理速度**: 約1,000件/10秒
- **メモリ使用量**: 約100MB（1,000件処理時）
- **ファイルサイズ**: 30MB以下のCSVファイルに対応
- **同時処理**: シングルスレッド（データ整合性重視）

## 🤝 貢献・開発

### 開発者向け情報

#### ローカル開発環境
```bash
# 開発用依存関係インストール
pip install -r requirements.txt

# Playwrightブラウザインストール（UIテスト用）
python -m playwright install

# アプリ起動
streamlit run app.py --server.port 8501
```

#### 新しいプロセッサーの追加
1. `processors/` ディレクトリに新しいプロセッサーを作成
2. `app.py` にUI処理を追加
3. ユニットテストを実装
4. ドキュメントを更新

### コード品質
- **モジュール化設計**: 各処理が独立したモジュール
- **エラーハンドリング**: 包括的な例外処理
- **ログ出力**: 詳細な処理ログ
- **型ヒント**: Pythonの型アノテーション使用

## 🛠️ Docker版操作ガイド

### 日常操作はバッチファイルで

| ファイル | 用途 | 説明 |
|----------|------|------|
| 起動.bat | 起動 | アプリを起動しブラウザを自動オープン（初回2-5分） |
| 停止.bat | 停止 | アプリを安全に停止しデータを保護 |
| 再起動.bat | 再起動 | 不具合時の簡単再起動（3分タイムアウト対応） |
| ログ確認.bat | ログ | 5種類のログ表示オプション |

### データの保存場所

| 種類 | フォルダ | 説明 |
|------|----------|------|
| アップロード | data/ | アップロードしたCSVファイル |
| ダウンロード | downloads/ | 処理結果のCSVファイル |
| ログ | logs/ | アプリケーション処理ログ |

### 📚 詳細ドキュメント

- **📋Docker版使い方.txt**: 初心者向け簡単マニュアル
- **docs/Docker_Desktop_インストールガイド.md**: 画像付きインストール手順
- **docs/トラブルシューティング.md**: よくある問題と解決策
- **docs/Docker基礎知識.md**: Docker初心者向け解説

---

## 📋 更新履歴

### v2.1.0-docker (2025/07/30) 🐳 **Docker化完全版**
- 🎉 **Docker化実装完了**: 環境非依存で配布可能なシステムに進化
- 🚀 **ワンクリック操作**: 4つのバッチファイルで簡単操作
- 📚 **完全ドキュメント**: 初心者向けから技術者向けまで網羅
- 🔧 **自動テスト**: 15種類プロセッサーの自動検証機能
- 📦 **配布自動化**: 配布パッケージ作成の完全自動化
- ✅ **文字化け解決**: 日本語環境統一でエンコーディング問題完全解決
- 🛠️ **Docker権限問題解決**: Permission denied エラーの根本解決（2時間のトラブルシューティング）

### v2.1.0 (2025/07/28)
- 🎉 プラザオートコール3種類実装完了（契約者/保証人/緊急連絡人）
- ✅ 2ファイル処理対応（ContractList + Excel報告書）
- ✅ 合計15種類のプロセッサーを統合した完全版アプリ
- ✅ フラットメニュー構造で操作性向上

### v2.0.0 (2025/07/28)
- 🎉 業務カテゴリ別の階層メニュー構造に刷新
- 📁 プロセッサーディレクトリの業務別再編成
- 🚀 将来拡張を見据えた設計（プラザ・SMS対応枠）
- ✅ start.batによるワンクリック起動実現

### v1.0.0 - v1.1.0 (2025/07/28)
- 🎉 統合アプリケーション初回リリース
- ✅ ミライル・フェイス・アーク処理の基盤実装
- ✅ StreamlitによるWebUI実装

## 🆘 トラブルシューティング

### Docker版でよくある問題

#### 1. 「Docker Desktop が起動していません」エラー
**解決策**: 
- Docker Desktop を起動（スタートメニューから検索）
- タスクトレイにクジラアイコンが表示されるまで待つ

#### 2. 「ポート 8501 が使用中」エラー
**解決策**: 
- 🛑停止.bat を実行
- 他のStreamlitアプリが起動していないか確認

#### 3. アプリが起動しない
**解決策**: 
- 📊ログ確認.bat でエラー内容を確認
- Docker Desktop を再起動
- 🔄再起動.bat を実行

#### 4. 「Permission denied」エラー（上級者向け）
**症状**: コンテナが無限再起動、`/root/.local/bin/streamlit: Permission denied`  
**解決済み**: v2.1.0-docker で根本解決済み  
**技術詳細**: Docker内ユーザー権限とファイル所有権の一貫性確保

### 従来版の問題（参考）

<details>
<summary>クリックして展開</summary>

#### 1. エンコーディングエラー
```
UnicodeDecodeError: 'cp932' codec can't decode...
```
**Docker版では解決済み**

#### 2. モジュールインポートエラー
```
ImportError: No module named 'processors.xxx'
```
**Docker版では解決済み**

#### 3. Streamlit起動エラー
```
Port 8501 is already in use
```
**Docker版では自動チェック機能付き**

</details>

### 📞 サポート
- **詳細ガイド**: docs/トラブルシューティング.md
- **GitHub Issues**: [business-data-processor/issues](https://github.com/TakuyaTsuchiya/business-data-processor/issues)
- **基礎知識**: docs/Docker基礎知識.md

## 📄 ライセンス

このプロジェクトは内部使用を目的としています。

## 👥 作成者

- **開発者**: Takuya Tsuchiya
- **AI支援**: Claude Code (Anthropic)
- **プロジェクト期間**: 2025年7月
- **Docker化**: 2025年7月30日

---

## 🎯 今後の展開

### 即座に可能
- **フェイスSMS機能実装**: 実装枠準備済み  
- **プラザ保証人プロセッサー完成化**: 基本構造実装済み
- **新システム追加**: 拡張可能アーキテクチャ

### 将来的な拡張
- **Linux/Mac対応**: Docker基盤により容易
- **クラウド配置**: コンテナ化により簡単
- **マルチユーザー対応**: 基盤技術対応済み

---

**🐳 Business Data Processor Docker版** - どこでも動く業務効率化システム