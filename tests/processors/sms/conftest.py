"""
SMS処理テスト用の共通フィクスチャ

【解説】
conftest.py はpytestの特別なファイルで、このディレクトリ内の
全テストファイルから自動的に読み込まれます。
共通のテストデータ（フィクスチャ）をここに定義します。
"""

import pytest
import pandas as pd
import numpy as np
from datetime import datetime, timedelta
from io import BytesIO


# =============================================================================
# 【解説】ミライルSMSの列番号マッピング
#
# ミライルSMSは「列名」ではなく「列番号」でデータにアクセスします。
# 例: df.iloc[:, 27] は28番目の列（0始まり）= AB列 = TEL携帯
# =============================================================================
MIRAIL_COLUMN_INDICES = {
    'クライアントCD': 97,    # CT列
    'TEL携帯': 27,           # AB列
    '滞納残債': 71,          # BT列
    '入金予定日': 72,        # BU列
    '入金予定金額': 73,      # BV列
    '回収ランク': 86,        # CI列
    '委託先法人ID': 118,     # DO列
}

# 列名でアクセスする列（これらは列名が必要）
MIRAIL_NAMED_COLUMNS = [
    '契約者氏名',
    '物件名',
    '物件番号',
    '管理番号',
    '回収口座銀行名',
    '回収口座支店名',
    '回収口座種類',
    '回収口座番号',
    '回収口座名義人',
]


def create_mirail_sms_dataframe(rows_data: list) -> pd.DataFrame:
    """
    【解説】ミライルSMS用のテストDataFrameを作成するヘルパー関数

    ミライルSMSは119列以上のCSVを想定しているため、
    テスト用に119列のダミーDataFrameを作成し、
    必要な列だけ実データを入れます。

    【重要】ミライルSMSは2つの方法でデータにアクセスします：
    1. 列番号（df.iloc[:, 118]）→ フィルター処理で使用
    2. 列名（df['滞納残債']）→ データマッピングで使用

    そのため、テストデータには両方が必要です。

    Args:
        rows_data: 各行のデータを含む辞書のリスト
        例: [
            {
                'TEL携帯': '090-1234-5678',
                '滞納残債': '10,000',
                '委託先法人ID': '5',
                ...
            },
            ...
        ]

    Returns:
        119列+名前付き列のDataFrame
    """
    # 119列のダミーDataFrameを作成（全て空文字）
    num_rows = len(rows_data)
    num_cols = 119

    # 全ての列を空文字で初期化
    df = pd.DataFrame(
        [['' for _ in range(num_cols)] for _ in range(num_rows)],
        columns=[f'col_{i}' for i in range(num_cols)]
    )

    # 列番号でアクセスする列にデータを設定
    for col_name, col_index in MIRAIL_COLUMN_INDICES.items():
        if col_index < num_cols:
            for row_idx, row_data in enumerate(rows_data):
                if col_name in row_data:
                    df.iloc[row_idx, col_index] = row_data[col_name]

    # 列名でアクセスする列を追加（これが重要！）
    # ミライルSMSはマッピング時に列名でアクセスするため
    for col_name in MIRAIL_NAMED_COLUMNS:
        df[col_name] = ''
        for row_idx, row_data in enumerate(rows_data):
            if col_name in row_data:
                df.loc[row_idx, col_name] = row_data[col_name]

    # 【追加】滞納残債は列番号71でもアクセスされるが、
    # マッピング時は列名でアクセスされるため、列名も追加
    df['滞納残債'] = ''
    for row_idx, row_data in enumerate(rows_data):
        if '滞納残債' in row_data:
            df.loc[row_idx, '滞納残債'] = row_data['滞納残債']

    return df


def dataframe_to_csv_bytes(df: pd.DataFrame, encoding: str = 'utf-8') -> bytes:
    """
    【解説】DataFrameをCSVのバイト列に変換

    SMS処理関数はファイルのバイト列を受け取るため、
    テストDataFrameをバイト列に変換する必要があります。

    Args:
        df: 変換するDataFrame
        encoding: 文字エンコーディング

    Returns:
        CSVファイルのバイト列
    """
    return df.to_csv(index=False, encoding=encoding).encode(encoding)


# =============================================================================
# 【解説】フィクスチャ（@pytest.fixture）
#
# フィクスチャは「テストの準備」を関数化したものです。
# テスト関数の引数にフィクスチャ名を書くだけで、
# pytestが自動的に準備してくれます。
# =============================================================================

@pytest.fixture
def valid_mirail_sms_data():
    """
    【解説】正常系テスト用データ

    全てのフィルター条件を通過するデータ。
    このデータは処理後に1件出力されるはずです。

    フィルター条件:
    1. 委託先法人ID: 5 または 空白
    2. 入金予定日: 前日以前
    3. 入金予定金額: 2,3,5,12 以外
    4. 回収ランク: 弁護士介入、訴訟中 以外
    5. 滞納残債: 1円以上
    6. TEL携帯: 090/080/070形式
    """
    yesterday = (datetime.now() - timedelta(days=1)).strftime('%Y/%m/%d')

    rows = [
        {
            'TEL携帯': '090-1234-5678',      # 有効な携帯番号
            '滞納残債': '10,000',            # 1円以上
            '入金予定日': yesterday,          # 前日（通過）
            '入金予定金額': '1',              # 除外対象外
            '回収ランク': '通常',             # 除外対象外
            '委託先法人ID': '5',              # 有効なID
            '契約者氏名': 'テスト太郎',
            '物件名': 'テストマンション',
            '物件番号': '101',
            '管理番号': 'M001',
            '回収口座銀行名': 'テスト銀行',
            '回収口座支店名': 'テスト支店',
            '回収口座種類': '普通',
            '回収口座番号': '1234567',
            '回収口座名義人': 'テスト名義',
        }
    ]
    return create_mirail_sms_dataframe(rows)


@pytest.fixture
def invalid_trustee_id_data():
    """
    【解説】委託先法人IDフィルターで除外されるデータ

    委託先法人IDが「5」でも「空白」でもない場合、
    このデータは除外されます。
    """
    yesterday = (datetime.now() - timedelta(days=1)).strftime('%Y/%m/%d')

    rows = [
        {
            'TEL携帯': '090-1234-5678',
            '滞納残債': '10,000',
            '入金予定日': yesterday,
            '入金予定金額': '1',
            '回収ランク': '通常',
            '委託先法人ID': '999',  # 無効なID → 除外される
            '契約者氏名': 'テスト太郎',
            '物件名': 'テストマンション',
            '物件番号': '101',
            '管理番号': 'M001',
            '回収口座銀行名': 'テスト銀行',
            '回収口座支店名': 'テスト支店',
            '回収口座種類': '普通',
            '回収口座番号': '1234567',
            '回収口座名義人': 'テスト名義',
        }
    ]
    return create_mirail_sms_dataframe(rows)


@pytest.fixture
def invalid_payment_date_data():
    """
    【解説】入金予定日フィルターで除外されるデータ

    入金予定日が「今日」または「未来」の場合、
    このデータは除外されます。
    """
    today = datetime.now().strftime('%Y/%m/%d')

    rows = [
        {
            'TEL携帯': '090-1234-5678',
            '滞納残債': '10,000',
            '入金予定日': today,  # 今日 → 除外される
            '入金予定金額': '1',
            '回収ランク': '通常',
            '委託先法人ID': '5',
            '契約者氏名': 'テスト太郎',
            '物件名': 'テストマンション',
            '物件番号': '101',
            '管理番号': 'M001',
            '回収口座銀行名': 'テスト銀行',
            '回収口座支店名': 'テスト支店',
            '回収口座種類': '普通',
            '回収口座番号': '1234567',
            '回収口座名義人': 'テスト名義',
        }
    ]
    return create_mirail_sms_dataframe(rows)


@pytest.fixture
def invalid_payment_amount_data():
    """
    【解説】入金予定金額フィルターで除外されるデータ

    入金予定金額が 2, 3, 5, 12 のいずれかの場合、
    このデータは除外されます。
    """
    yesterday = (datetime.now() - timedelta(days=1)).strftime('%Y/%m/%d')

    rows = [
        {
            'TEL携帯': '090-1234-5678',
            '滞納残債': '10,000',
            '入金予定日': yesterday,
            '入金予定金額': '5',  # 除外対象 → 除外される
            '回収ランク': '通常',
            '委託先法人ID': '5',
            '契約者氏名': 'テスト太郎',
            '物件名': 'テストマンション',
            '物件番号': '101',
            '管理番号': 'M001',
            '回収口座銀行名': 'テスト銀行',
            '回収口座支店名': 'テスト支店',
            '回収口座種類': '普通',
            '回収口座番号': '1234567',
            '回収口座名義人': 'テスト名義',
        }
    ]
    return create_mirail_sms_dataframe(rows)


@pytest.fixture
def invalid_collection_rank_data():
    """
    【解説】回収ランクフィルターで除外されるデータ

    回収ランクが「弁護士介入」または「訴訟中」の場合、
    このデータは除外されます。
    """
    yesterday = (datetime.now() - timedelta(days=1)).strftime('%Y/%m/%d')

    rows = [
        {
            'TEL携帯': '090-1234-5678',
            '滞納残債': '10,000',
            '入金予定日': yesterday,
            '入金予定金額': '1',
            '回収ランク': '弁護士介入',  # 除外対象 → 除外される
            '委託先法人ID': '5',
            '契約者氏名': 'テスト太郎',
            '物件名': 'テストマンション',
            '物件番号': '101',
            '管理番号': 'M001',
            '回収口座銀行名': 'テスト銀行',
            '回収口座支店名': 'テスト支店',
            '回収口座種類': '普通',
            '回収口座番号': '1234567',
            '回収口座名義人': 'テスト名義',
        }
    ]
    return create_mirail_sms_dataframe(rows)


@pytest.fixture
def invalid_arrears_data():
    """
    【解説】滞納残債フィルターで除外されるデータ

    滞納残債が0円以下の場合、このデータは除外されます。
    """
    yesterday = (datetime.now() - timedelta(days=1)).strftime('%Y/%m/%d')

    rows = [
        {
            'TEL携帯': '090-1234-5678',
            '滞納残債': '0',  # 0円 → 除外される
            '入金予定日': yesterday,
            '入金予定金額': '1',
            '回収ランク': '通常',
            '委託先法人ID': '5',
            '契約者氏名': 'テスト太郎',
            '物件名': 'テストマンション',
            '物件番号': '101',
            '管理番号': 'M001',
            '回収口座銀行名': 'テスト銀行',
            '回収口座支店名': 'テスト支店',
            '回収口座種類': '普通',
            '回収口座番号': '1234567',
            '回収口座名義人': 'テスト名義',
        }
    ]
    return create_mirail_sms_dataframe(rows)


@pytest.fixture
def invalid_phone_data():
    """
    【解説】携帯電話番号フィルターで除外されるデータ

    TEL携帯が 090/080/070 形式でない場合、
    このデータは除外されます。
    """
    yesterday = (datetime.now() - timedelta(days=1)).strftime('%Y/%m/%d')

    rows = [
        {
            'TEL携帯': '03-1234-5678',  # 固定電話 → 除外される
            '滞納残債': '10,000',
            '入金予定日': yesterday,
            '入金予定金額': '1',
            '回収ランク': '通常',
            '委託先法人ID': '5',
            '契約者氏名': 'テスト太郎',
            '物件名': 'テストマンション',
            '物件番号': '101',
            '管理番号': 'M001',
            '回収口座銀行名': 'テスト銀行',
            '回収口座支店名': 'テスト支店',
            '回収口座種類': '普通',
            '回収口座番号': '1234567',
            '回収口座名義人': 'テスト名義',
        }
    ]
    return create_mirail_sms_dataframe(rows)


@pytest.fixture
def mixed_data():
    """
    【解説】複数パターンを含むテストデータ

    フィルター通過するデータと除外されるデータを混ぜたもの。
    統合テストで「正しい件数が出力されるか」を確認します。
    """
    yesterday = (datetime.now() - timedelta(days=1)).strftime('%Y/%m/%d')
    today = datetime.now().strftime('%Y/%m/%d')

    rows = [
        # 1. 全て通過 → 出力される
        {
            'TEL携帯': '090-1111-1111',
            '滞納残債': '10,000',
            '入金予定日': yesterday,
            '入金予定金額': '1',
            '回収ランク': '通常',
            '委託先法人ID': '5',
            '契約者氏名': '通過太郎',
            '物件名': 'テストマンション',
            '物件番号': '101',
            '管理番号': 'M001',
            '回収口座銀行名': 'テスト銀行',
            '回収口座支店名': 'テスト支店',
            '回収口座種類': '普通',
            '回収口座番号': '1234567',
            '回収口座名義人': 'テスト名義',
        },
        # 2. 委託先法人IDで除外
        {
            'TEL携帯': '090-2222-2222',
            '滞納残債': '10,000',
            '入金予定日': yesterday,
            '入金予定金額': '1',
            '回収ランク': '通常',
            '委託先法人ID': '999',  # 除外
            '契約者氏名': '除外二郎',
            '物件名': 'テストマンション',
            '物件番号': '102',
            '管理番号': 'M002',
            '回収口座銀行名': 'テスト銀行',
            '回収口座支店名': 'テスト支店',
            '回収口座種類': '普通',
            '回収口座番号': '1234567',
            '回収口座名義人': 'テスト名義',
        },
        # 3. 全て通過（空白の委託先法人ID）→ 出力される
        {
            'TEL携帯': '080-3333-3333',
            '滞納残債': '5,000',
            '入金予定日': yesterday,
            '入金予定金額': '1',
            '回収ランク': '通常',
            '委託先法人ID': '',  # 空白はOK
            '契約者氏名': '通過三郎',
            '物件名': 'テストマンション',
            '物件番号': '103',
            '管理番号': 'M003',
            '回収口座銀行名': 'テスト銀行',
            '回収口座支店名': 'テスト支店',
            '回収口座種類': '普通',
            '回収口座番号': '1234567',
            '回収口座名義人': 'テスト名義',
        },
        # 4. 弁護士介入で除外
        {
            'TEL携帯': '070-4444-4444',
            '滞納残債': '10,000',
            '入金予定日': yesterday,
            '入金予定金額': '1',
            '回収ランク': '弁護士介入',  # 除外
            '委託先法人ID': '5',
            '契約者氏名': '除外四郎',
            '物件名': 'テストマンション',
            '物件番号': '104',
            '管理番号': 'M004',
            '回収口座銀行名': 'テスト銀行',
            '回収口座支店名': 'テスト支店',
            '回収口座種類': '普通',
            '回収口座番号': '1234567',
            '回収口座名義人': 'テスト名義',
        },
    ]
    return create_mirail_sms_dataframe(rows)


@pytest.fixture
def payment_deadline_date():
    """
    【解説】支払期限日のフィクスチャ

    SMS処理には支払期限日（date型）を渡す必要があります。
    """
    from datetime import date
    return date(2025, 12, 31)
